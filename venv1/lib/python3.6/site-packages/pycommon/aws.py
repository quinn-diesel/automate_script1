import json
import urllib

import boto3

from pycommon.cases import snake_case_keys


_lambda_client = boto3.client('lambda')


def unpack_sns_messages(event):
    return [snake_case_keys(json.loads(e['Sns']['Message'])) for e in event['Records']]


def dynamo_item_to_dict(data):
    boto3.resource('dynamodb')
    deserializer = boto3.dynamodb.types.TypeDeserializer()
    return {k: deserializer.deserialize(v) for k, v in data.items()}


def make_s3_public_url(region, bucket, key):
    return 'https://s3-{}.amazonaws.com/{}/{}'.format(region, bucket, urllib.parse.quote(key))


def invoke_lambda(function, payload):
    response = _lambda_client.invoke(
        FunctionName=function,
        LogType='None',
        InvocationType='RequestResponse',
        Payload=json.dumps(payload),
    )
    return json.loads(response['Payload'].read().decode('utf-8'))
