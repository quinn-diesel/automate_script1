import os

from elasticsearch import Elasticsearch, RequestsHttpConnection, exceptions
from aws_requests_auth.aws_auth import AWSRequestsAuth


def get_auth():
    return AWSRequestsAuth(aws_access_key=os.environ['AWS_ACCESS_KEY_ID'],
                           aws_secret_access_key=os.environ['AWS_SECRET_ACCESS_KEY'],
                           aws_token=os.environ['AWS_SESSION_TOKEN'],
                           aws_host=os.environ['ELASTIC_URL'],
                           aws_region=os.environ['AWS_REGION'],
                           aws_service='es')


def get_es_client():
    return Elasticsearch([{
        'host': os.environ['ELASTIC_URL'],
        'port': 443,
        'use_ssl': True
    }],
        connection_class=RequestsHttpConnection,
        http_auth=get_auth(),
        use_ssl=True,
        verify_certs=True)


def iter_models(result, model):
    exclude = ['omni']
    return [model(**{k: v for k, v in doc['_source'].items() if k not in exclude})
            for doc in result['hits']['hits']]
